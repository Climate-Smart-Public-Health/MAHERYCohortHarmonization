---
title: "flat_preprocess_2018_health.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r setup}  
library(here)
library(targets)
tar_load(opensrp, store = here::here("_targets"))
tar_load(opensrp_dict, store = here::here("_targets"))
tar_load(cohort_2018_deid, store = here::here("_targets"))

# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)

library(janitor)
library(dplyr)
library(tidyr)
library(lubridate)
library(skimr)
library(forcats)
library(stringr)
```

In this notebook we're tackling the health data from the cohort 2018 opensrp file. We decided to
leave this to a separate processing step because the health data is a bit more complex than the household registration and demographic data.

Let's begin:

## Reading in the data

The data is read in from the targets pipeline, and is contained in the `opensrp` object.

```{r}
open_census <- opensrp$`Open census`

head(open_census)
```

In this _specific case_, the raw data in the open census file is the same number of rows as the
processed targets output, so I'm going to join the raw data to the health columns.

```{r}
open_census %>%
  clean_names() %>%
  # remove this individual as they are specifically excluded from the cohort as a duplicate
  filter(!str_detect(member, "36841201")) %>%
  select(prior_health_care:deathyear) %>%
  bind_cols(select(cohort_2018_deid, uuid_clean = uuid, sex_clean = sex, age_group_clean = age_group), .) -> health_data
```

Now let's take a look at the data:
```{r}
skimr::skim(health_data)
```

## Health Care Access

The first thing to determine is whether `prior_health_care` refers to,
"does this person have a history of a health care condition," or something else.

```{r}
health_data %>%
  select(prior_health_care, prior_diagnosis) %>%
  table()
```

From this it would appear that prior healthcare is a yes/no question
that tells us if they have any history of health care conditions.

```{r}
health_data %>%
  mutate(prior_health_condition_clean = case_when(
    prior_health_care == "Yes" ~ "Yes", 
    !is.na(prior_diagnosis) ~ "Yes",
    TRUE ~ "No")
    ) -> health_data_
```

Now let's look at the `prior_diagnosis` column:

```{r}
health_data_ %>%
  select(prior_diagnosis) %>%
  table()
```

```{r}
health_data_ %>%
  select(other_prior_diagnosis) %>%
  table()
```

In the secondary column, we see many values that are translated. We'll translate
these manually and then cast them width wise to create a wide format table.

First, we mutate the `prior_diagnosis` column to make sure a diagnosis is one word, or clearly separated by a comma:

```{r}
health_data_ %>%
  mutate(prior_diagnosis_ = 
    prior_diagnosis %>% 
      str_to_lower() %>%
      str_replace("infected wound prior diagnosis other", "infected_wound") %>%
      str_replace("malaria cancer", "malaria,cancer") %>%
      str_replace("malaria prior diagnosis other", "malaria") %>%
      str_replace("no pregnancy prior diagnosis other", "no_pregnancy") %>%
      str_replace("no pregnancy", "no_pregnancy") %>%
      str_replace("prior diagnosis other", "other") %>%
      str_replace("hypertension idr", "hypertension") %>%
      str_replace("no diagnosis", NA_character_) %>%
      str_replace("idr", NA_character_)
  ) %>%
  select(prior_diagnosis_) %>%
  table()
```

Then, we concatenate the `prior_diagnosis` and `other_prior_diagnosis` columns to create a single diagnosis column separated by commas:

```{r}
health_data_ %>%
  mutate(prior_diagnosis_ = 
    prior_diagnosis %>% 
      str_to_lower() %>%
      str_replace("infected wound prior diagnosis other", "infected_wound") %>%
      str_replace("malaria cancer", "malaria,cancer") %>%
      str_replace("malaria prior diagnosis other", "malaria") %>%
      str_replace("no pregnancy prior diagnosis other", "no_pregnancy") %>%
      str_replace("no pregnancy", "no_pregnancy") %>%
      str_replace("prior diagnosis other", "other") %>%
      str_replace("hypertension idr", "hypertension") %>%
      str_replace("no diagnosis", NA_character_) %>%
      str_replace("idr", NA_character_)
  ) %>%
  mutate(other_prior_diagnosis = 
    other_prior_diagnosis %>% 
      str_to_lower() %>%
      str_replace("infected wound prior diagnosis other", "infected_wound") %>%
      str_replace("malaria cancer", "malaria,cancer") %>%
      str_replace("malaria prior diagnosis other", "malaria") %>%
      str_replace("no pregnancy prior diagnosis other", "no_pregnancy") %>%
      str_replace("no pregnancy", "no_pregnancy") %>%
      str_replace("prior diagnosis other", "other") %>%
      str_replace("hypertension idr", "hypertension") %>%
      str_replace("no diagnosis", NA_character_) %>%
      str_replace("idr", NA_character_)
  ) %>%
  unite(diagnoses_all, prior_diagnosis_, other_prior_diagnosis, sep = ",", remove=FALSE, na.rm=TRUE) %>%
  mutate(
    diagnoses_all = 
      str_squish(diagnoses_all) %>% 
        str_replace(", ", ",") %>%
        str_replace(" ", "_") %>%
        # if it just starts with "other," it means it has only "other diagnosis"
        # and can be safely removed
        str_replace("^other,", "") %>%
        # which means the ones that are 999 are true "other" diagnoses
        # with no specification in english
        str_replace("999", "other_unspecified")
  ) %>%
  mutate(diagnoses_all = na_if(diagnoses_all, "")) %>%
  select(diagnoses_all) %>%
  table()
```

Now we have a single column with all diagnoses separated by a comma. We can
use this to create a wide format table with each diagnosis as a column.

These values can then be translated and categorised into ICD10 categories, which might be useful
for cross-cultural comparisons and publications.
    
```{r malagasy_diagnosis_lookup_table}
malagasy_diagnosis_lookup_table <- tibble::tribble(
  ~raw,                  ~diagnosis_english,             ~icd10_code,       ~icd10_description,
  "aretim_bavony",       "Gastrointestinal",             "K00–K95",         "Diseases of the digestive system",
  "adetin_kibo",         "Gastrointestinal",             "K00–K95",         "Diseases of the digestive system",
  "farasisa",            "Hernia or Prolapse",           "K40–K46",         "Hernia",
  "hernie",              "Hernia or Prolapse",           "K40–K46",         "Hernia",
  "voatombo_komby",      "Hernia or Prolapse",           "K40–K46",         "Hernia",
  "zonisy,farasisa",     "Hernia or Prolapse",           "K40–K46",         "Hernia",
  "aretintsofina",       "ENT (Ear/Nose/Throat)",        "H60–H95",         "Diseases of the ear and mastoid process",
  "hoditra_fotsy",       "Genetic / Albinism",           "E70–E90",         "Metabolic disorders",
  "solopiso",            "Neurological (Epilepsy)",      "G40–G47",         "Episodic and paroxysmal disorders",
  "mentally_handicapped","Developmental / Cognitive",    "F70–F79",         "Intellectual disabilities",
  "bongabe",             "Swelling / Mass",              "R20–R23",         "Symptoms and signs involving the skin and subcutaneous tissue",
  "mangoraka,tadigny",   "Dermatologic",                 "L00–L99",         "Diseases of the skin and subcutaneous tissue",
  "tadigny",             "Dermatologic",                 "L00–L99",         "Diseases of the skin and subcutaneous tissue",
  "matetika_tontona",    "Dizziness / Syncope",          "R40–R46",         "Symptoms and signs involving cognition, perception, emotional state and behavior",
  "tontona",             "Dizziness / Syncope",          "R40–R46",         "Symptoms and signs involving cognition, perception, emotional state and behavior",
  "sohiky",              "Musculoskeletal Deformity",    "M40–M54",         "Dorsopathies",
  "soiky",               "Musculoskeletal Deformity",    "M40–M54",         "Dorsopathies",
  "torantorana",         "Motor Disability",             "M60–M79",         "Soft tissue disorders",
  "hypertension",        "Hypertension",                 "I10–I15",         "Hypertensive diseases",
  "malaria",             "Malaria",                      "B50–B64",         "Protozoal diseases",
  "tuberculosis",        "Tuberculosis",                 "A15–A19",         "Tuberculosis",
  "infected_wound",      "Skin or soft tissue infection","L00–L08",         "Infections of the skin and subcutaneous tissue",
  "no_pregnancy",        "Pregnancy-related",            "O00–O99",         "Pregnancy, childbirth and the puerperium",
  "cancer",              "Neoplasm (unspecified)",       "C00–D49",         "Neoplasms",
  "other",               "Other / Unknown",              "R00–R99",         "Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified"
)
# Save to package
usethis::use_data(malagasy_diagnosis_lookup_table, overwrite = TRUE)
```

You can examine this lookup table in the vignette [`Pipeline Outputs`](OutputTables.html).

```{r function-malagasy_diagnosis_lookup_table}
#' Malagasy Diagnosis Lookup Table
#' 
#' A lookup table mapping raw diagnosis entries (from Malagasy or English inputs)
#' to standardized English diagnosis labels and ICD-10 chapter-level codes.
#'
#' Used in conjunction with `create_health_diagnoses()` to clean and harmonize
#' multi-source survey data (e.g., `prior_diagnosis`, `other_prior_diagnosis`, or `diagnoses_all`).
#'
#' @format A tibble with 3 columns:
#' \describe{
#'   \item{raw}{Raw input string from survey data}
#'   \item{diagnosis_english}{Cleaned harmonized English label}
#'   \item{icd10_code}{ICD-10 chapter or block code (e.g. "K00–K95")}
#' }
#' @source Manually curated from OpenSRP 2018 health survey entries in the \link[=preprocessing-2018-health-status]{Health Preprocessing} vignette.
"malagasy_diagnosis_lookup_table"
```
  
With that, we can implement it in the function:

```{r development-create_health_diagnoses}
# You can prepare the code of the create_health_diagnoses() function here
```
  
```{r function-create_health_diagnoses}
#' Title
#' 
#' Description
#' 
#' @return
#' 
#' @export
create_health_diagnoses <- function(df, diagnosis_lookup=malagasy_diagnosis_lookup_table){

  df %>%
    mutate(prior_diagnosis_ = 
      prior_diagnosis %>% 
        str_to_lower() %>%
        str_replace("infected wound prior diagnosis other", "infected_wound") %>%
        str_replace("malaria cancer", "malaria,cancer") %>%
        str_replace("malaria prior diagnosis other", "malaria") %>%
        str_replace("no pregnancy prior diagnosis other", "no_pregnancy") %>%
        str_replace("no pregnancy", "no_pregnancy") %>%
        str_replace("prior diagnosis other", "other") %>%
        str_replace("hypertension idr", "hypertension") %>%
        str_replace("no diagnosis", NA_character_) %>%
        str_replace("idr", NA_character_)
    ) %>%
    mutate(other_prior_diagnosis = 
      other_prior_diagnosis %>% 
        str_to_lower() %>%
        str_replace("infected wound prior diagnosis other", "infected_wound") %>%
        str_replace("malaria cancer", "malaria,cancer") %>%
        str_replace("malaria prior diagnosis other", "malaria") %>%
        str_replace("no pregnancy prior diagnosis other", "no_pregnancy") %>%
        str_replace("no pregnancy", "no_pregnancy") %>%
        str_replace("prior diagnosis other", "other") %>%
        str_replace("hypertension idr", "hypertension") %>%
        str_replace("no diagnosis", NA_character_) %>%
        str_replace("idr", NA_character_)
    ) %>%
    unite(diagnoses_all, prior_diagnosis_, other_prior_diagnosis, sep = ",", remove=FALSE, na.rm=TRUE) %>%
    mutate(
      diagnoses_all = 
        str_squish(diagnoses_all) %>% 
          str_replace(", ", ",") %>%
          str_replace(" ", "_") %>%
          # if it just starts with "other," it means it has only "other diagnosis"
          # and can be safely removed
          str_replace("^other,", "") %>%
          # which means the ones that are 999 are true "other" diagnoses
          # with no specification in english
          str_replace("999", "other_unspecified")
    ) %>%
    mutate(diagnoses_all = na_if(diagnoses_all, "")) %>%

    # step 1: Unnest and match diagnoses
    mutate(id = row_number()) %>%
    separate_rows(diagnoses_all, sep = ",") %>%
    mutate(diagnoses_all = str_trim(diagnoses_all)) %>%
    left_join(diagnosis_lookup, by = c("diagnoses_all" = "raw")) %>%
    filter(!is.na(diagnosis_english)) -> long_df

    # Step 2: Create wide one-hot matrix
    wide_matrix <- long_df %>%
      mutate(present = 1) %>%
      distinct(id, diagnosis_english, present) %>%
      pivot_wider(names_from = diagnosis_english, values_from = present, values_fill = 0)

    # Step 3: Join back to original data
    output <- df %>%
      mutate(id = row_number()) %>%
      left_join(
        long_df %>%
          group_by(id) %>%
          summarise(
            diagnosis_english = paste(unique(diagnosis_english), collapse = ", "),
            diagnosis_icd10_code = paste(unique(icd10_code), collapse = ", ")
          ),
        by = "id"
      ) %>%
      left_join(wide_matrix, by = "id") %>%
      select(-id)

    return(output)
}
```
  
```{r example-create_health_diagnoses, eval=FALSE}
health_data_ %>% 
  create_health_diagnoses(diagnosis_lookup = MAHERYCohortHarmonization::malagasy_diagnosis_lookup_table) %>%
  rename(diagnosis_english_clean = diagnosis_english, diagnosis_icd10_code_clean = diagnosis_icd10_code) -> health_data_
```
  
```{r tests-create_health_diagnoses}
test_that("create_health_diagnoses works", {
  expect_true(inherits(create_health_diagnoses, "function")) 
})
```

## Ad hoc Healthcare Variables

Now we can deal with the easier stuff:

```{r}
health_data_ %>% select(pregnant) %>% table()
  mutate(
    has_healthcare = case_when(
      prior_health_care == "Yes" ~ TRUE,
      prior_health_care == "No" ~ FALSE,
      TRUE ~ NA
    ),
    has_healthcare = as.logical(has_healthcare),
    has_healthcare = ifelse(is.na(has_healthcare), NA, has_healthcare)
  ) -> health_data_
```

# preprocess_2018_health

```{r development-preprocess_2018_health}
# Prepare the code of your function here
```

```{r function-preprocess_2018_health}
#' preprocess_2018_health Title
#'
#' @return 1
#' @export
#'
#' @examples
preprocess_2018_health <- function() {
  1
}
```

```{r examples-preprocess_2018_health}
preprocess_2018_health()
```

```{r tests-preprocess_2018_health}
test_that("preprocess_2018_health works", {
  expect_true(inherits(preprocess_2018_health, "function"))
})
```


```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_preprocess_2018_health.Rmd", vignette_name = "Preprocessing 2018 Health Status", check=FALSE, open_vignette = FALSE)
```

