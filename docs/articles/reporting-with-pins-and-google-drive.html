<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Reporting with pins and Google Drive ‚Ä¢ MAHERYCohortHarmonization</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Reporting with pins and Google Drive">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MAHERYCohortHarmonization</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/opensrp-cohort-2018-preprocessing.html">OpenSRP Cohort 2018 Preprocessing</a></li>
    <li><a class="dropdown-item" href="../articles/OutputTables.html">Pipeline Outputs</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing-2018-health-status.html">Preprocessing 2018 Health Status</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing-2018-household-heads.html">Preprocessing 2018 Household Heads</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing-2019-health-status.html">Preprocessing 2019 Health Status</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing-dharma-2019-cohort.html">Preprocessing Dharma 2019 Cohort</a></li>
    <li><a class="dropdown-item" href="../articles/reporting-with-pins-and-google-drive.html">Reporting with pins and Google Drive</a></li>
    <li><a class="dropdown-item" href="../articles/tracking-input-data.html">Tracking Input Data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Reporting with pins and Google Drive</h1>
            
      

      <div class="d-none name"><code>reporting-with-pins-and-google-drive.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MAHERYCohortHarmonization</span><span class="op">)</span></span></code></pre></div>
<!-- WARNING - This vignette is generated by {fusen} from dev/flat_reporting_pins.Rmd: do not edit by hand -->
<div class="section level2">
<h2 id="reporting-with-pins-compliant-data">Reporting with <code>pins</code> Compliant Data<a class="anchor" aria-label="anchor" href="#reporting-with-pins-compliant-data"></a>
</h2>
<p>This notebook creates a template for functions for reporting using
the <code>pins</code> package.</p>
<p>The motivation for these functions is that we want a consistent way
to report results from the pipeline, but the data cannot be shared
directly on a github pages site due to privacy concerns. The
<code>pins</code> package allows us to store data in a remote location,
such as a cloud storage service, and share it with collaborators without
exposing sensitive information. The functions in this notebook will be
used to create a consistent interface for reporting results from the
pipeline to the GoogleDrive folder</p>
<p>To use GoogleDrive as a pin board, you first need to set up a folder
on Google Drive and assign it as a board:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#install.packages("pins")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pins.rstudio.com/" class="external-link">pins</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; here() starts at /net/rcstorenfs02/ifs/rc_labs/dominici_lab/lab/data_processing/csph_MDG-SurveyHarmonization/MAHERYCohortHarmonization</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org" class="external-link">fs</a></span><span class="op">)</span></span></code></pre></div>
<p>As part of our Lab Organization efforts, we have created a designated
drive folder for all things MAHERY Cohort Harmonization. In this folder,
we‚Äôre going to dedicated a subfolder for the pinboard at
<code>/Projects/Climate-Smart Public Health - Madagascar/5. Data &amp; Code Elements/pin_boards/MAHERYCohortHarmonization</code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Note that the board name matches the GitHub repository
name exactly. The path to the pin board can be stored as an environment
variable as a share link generated from Google as normal. As with our
tracking data pipeline settings, we also need to share the folder with
the Google Drive service account (but this can be shared with your
personal Google Drive if you prefer).&lt;/p&gt;"><sup>1</sup></a></p>
<p>You can create a pinboard with the following code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># important: you cannot use the data pipeline account to authenticate</span></span>
<span><span class="co"># because it does not have access to the entire shared drive</span></span>
<span><span class="co"># therefore, we have to leave this as eval = FALSE in the vignette</span></span>
<span><span class="co"># because it's going to require live, interactive authentication</span></span>
<span></span>
<span><span class="fu">googledrive</span><span class="fu">::</span><span class="fu"><a href="https://googledrive.tidyverse.org/reference/drive_auth.html" class="external-link">drive_auth</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shared_folder_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GOOGLE_DRIVE_PIN_BOARD"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mahery_board</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pins.rstudio.com/reference/board_gdrive.html" class="external-link">board_gdrive</a></span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="fu">googledrive</span><span class="fu">::</span><span class="fu"><a href="https://googledrive.tidyverse.org/reference/drive_id.html" class="external-link">as_id</a></span><span class="op">(</span><span class="va">shared_folder_id</span><span class="op">)</span>,</span>
<span>  versioned <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cache <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">mahery_board</span><span class="op">)</span></span></code></pre></div>
<p>Now that the board is set, we can demo ‚Äúpinning‚Äù an object to the
board:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mahery_board</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pins.rstudio.com/reference/pin_read.html" class="external-link">pin_write</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">mtcars</span>, </span>
<span>    name <span class="op">=</span> <span class="st">"mtcars"</span>, </span>
<span>    description <span class="op">=</span> <span class="st">"A dataset of motor trend car road tests"</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"csv"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can see that <code>mtcars</code> is now available on the
pinboard.</p>
<div class="float">
<img src="mtcars_folder.png" alt="mtcars pinboard"><div class="figcaption">mtcars pinboard</div>
</div>
<p>It comes with a text file that describes the dataset, and a CSV file
with the data:</p>
<pre><code>file: mtcars.csv
file_size: 1303
pin_hash: 48c73eef04b242dd
type: csv
title: 'mtcars: a pinned 32 x 11 data frame'
description: A dataset of motor trend car road tests
tags: ~
urls: ~
created: 20250606T161202Z
api_version: 1</code></pre>
<p>So it‚Äôs imperative to be descriptive so that the pinboard is useful
for others.</p>
</div>
<div class="section level2">
<h2 id="reporting-with-pins-non-compliant-data">Reporting with <code>pins</code> Non-Compliant Data<a class="anchor" aria-label="anchor" href="#reporting-with-pins-non-compliant-data"></a>
</h2>
<p><code>pins</code> works very well with serialized R objects and plain
text data files, but it does not work well with other binary data
formats such as images, PDFs, or other non-text files. To report these
types of data, we‚Äôll have to configure our own
<code><a href="../reference/to_pinboard.html">to_pinboard()</a></code> function, which will take the R object and
convert it as necessary to a format that can simply be uploaded to the
shared drive without the need for <code>pins</code>. This is useful for
reporting figures, tables, and other non-text data, but of course loses
the benefits of versioning and metadata that <code>pins</code>
provides.</p>
<p>For example, to share a figure, we‚Äôll have to save it as a PNG file
and then upload it to the shared drive.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shared_folder_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GOOGLE_DRIVE_PIN_BOARD"</span><span class="op">)</span></span>
<span><span class="va">out_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://fs.r-lib.org/reference/file_temp.html" class="external-link">file_temp</a></span><span class="op">(</span><span class="st">"test_plot"</span>, ext <span class="op">=</span> <span class="st">".png"</span><span class="op">)</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">wt</span>, y <span class="op">=</span> <span class="va">mpg</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Motor Trend Car Road Tests"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Weight (1000 lbs)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Miles per Gallon"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">p</span></span>
<span>  </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="va">out_file</span>, plot <span class="op">=</span> <span class="va">p</span>, width <span class="op">=</span> <span class="fl">8</span>, height <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://googledrive.tidyverse.org/reference/drive_upload.html" class="external-link">drive_upload</a></span><span class="op">(</span></span>
<span>  media <span class="op">=</span> <span class="va">out_file</span>,</span>
<span>  path <span class="op">=</span> <span class="fu">googledrive</span><span class="fu">::</span><span class="fu"><a href="https://googledrive.tidyverse.org/reference/drive_id.html" class="external-link">as_id</a></span><span class="op">(</span><span class="va">shared_folder_id</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"test_plot.png"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"image/png"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Using an auto-discovered, cached token.</span></span>
<span><span class="co">#&gt;   To suppress this message, modify your code or options to clearly consent to</span></span>
<span><span class="co">#&gt;   the use of a cached token.</span></span>
<span><span class="co">#&gt;   See gargle's "Non-interactive auth" vignette for more details:</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB; font-style: italic;">&lt;https://gargle.r-lib.org/articles/non-interactive-auth.html&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">‚Ñπ</span> The <span style="color: #0000BB;">googledrive</span> package is using a cached token for <span style="color: #0000BB;">tinashemtapera@gmail.com</span>.</span></span>
<span><span class="co">#&gt; Auto-refreshing stale OAuth token.</span></span>
<span><span class="co">#&gt; File trashed:</span></span>
<span><span class="co">#&gt; ‚Ä¢ <span style="color: #00BBBB;">test_plot.png</span> <span style="color: #555555;">&lt;id: 1B1-o_keJ2DvaB4b7LuNAVT2hPYk-V16P&gt;</span></span></span>
<span><span class="co">#&gt; Local file:</span></span>
<span><span class="co">#&gt; ‚Ä¢ <span style="color: #0000BB;">/tmp/RtmpvVrrRA/test_plot78cc55fc610ec.png</span></span></span>
<span><span class="co">#&gt; Uploaded into Drive file:</span></span>
<span><span class="co">#&gt; ‚Ä¢ <span style="color: #00BBBB;">test_plot.png</span> <span style="color: #555555;">&lt;id: 16FhuLmImi_kceVHqVOj1r04FnfRJlhsU&gt;</span></span></span>
<span><span class="co">#&gt; With MIME type:</span></span>
<span><span class="co">#&gt; ‚Ä¢ <span style="color: #00BB00;">image/png</span></span></span></code></pre></div>
<p>This will upload the plot to the shared drive, but it won‚Äôt have any
metadata or versioning that <code>pins</code> offers.</p>
<div class="float">
<img src="test_plot_in_folder.png" alt="Figure: test_plot.png"><div class="figcaption">Figure: test_plot.png</div>
</div>
<p>Now, let‚Äôs create a general function that can be used to share
reporting outputs either as pins or as files on the shared drive.</p>
</div>
<div class="section level2">
<h2 id="to_pinboard-function">to_pinboard() Function<a class="anchor" aria-label="anchor" href="#to_pinboard-function"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example usage of to_pinboard function</span></span>
<span><span class="fu"><a href="../reference/to_pinboard.html">to_pinboard</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">mtcars</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"mtcars"</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"A dataset of motor trend car road tests"</span>,</span>
<span>  board <span class="op">=</span> <span class="va">mahery_board</span>,</span>
<span>  as_file <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"csv"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For interest‚Äôs sake, here‚Äôs the raw code for the function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MAHERYCohortHarmonization</span><span class="fu">::</span><span class="va"><a href="../reference/to_pinboard.html">to_pinboard</a></span></span>
<span><span class="co">#&gt; function (object, name, description, board, as_file = FALSE, </span></span>
<span><span class="co">#&gt;     type = "rds") </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     if (as_file) {</span></span>
<span><span class="co">#&gt;         stopifnot(fs::file_exists(object))</span></span>
<span><span class="co">#&gt;         googledrive::drive_upload(media = object, path = board$dribble$id, </span></span>
<span><span class="co">#&gt;             name = name, type = mime::guess_type(object) %||% </span></span>
<span><span class="co">#&gt;                 "application/octet-stream", overwrite = TRUE)</span></span>
<span><span class="co">#&gt;         message(glue::glue("‚úÖ Uploaded file '{name}' to Google Drive folder. Description:\n{description}"))</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     else {</span></span>
<span><span class="co">#&gt;         board %&gt;% pins::pin_write(x = object, name = name, description = description, </span></span>
<span><span class="co">#&gt;             type = type)</span></span>
<span><span class="co">#&gt;         message(glue::glue("üìå Pinned object '{name}' to pin board"))</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x5ffb648&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:MAHERYCohortHarmonization&gt;</span></span></code></pre></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tinashe Tapera.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
