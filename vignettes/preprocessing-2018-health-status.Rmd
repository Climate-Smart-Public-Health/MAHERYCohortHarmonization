---
title: "Preprocessing 2018 Health Status"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Preprocessing 2018 Health Status}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library(MAHERYCohortHarmonization)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/flat_preprocess_2018_health.Rmd: do not edit by hand -->



```{r setup}
library(here)
library(targets)
tar_load(opensrp, store = here::here("_targets"))
tar_load(opensrp_dict, store = here::here("_targets"))
tar_load(cohort_2018_deid, store = here::here("_targets"))

# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)

library(janitor)
library(dplyr)
library(tidyr)
library(lubridate)
library(skimr)
library(forcats)
library(stringr)
```


In this notebook we're tackling the health data from the cohort 2018 opensrp file. We decided to
leave this to a separate processing step because the health data is a bit more complex than the household registration and demographic data.

Let's begin:

## Reading in the data

The data is read in from the targets pipeline, and is contained in the `opensrp` object.
```{r}
open_census <- opensrp$`Open census`

head(open_census)
```


In this _specific case_, the raw data in the open census file is the same number of rows as the
processed targets output, so I'm going to join the raw data to the health columns.
```{r}
open_census %>%
  clean_names() %>%
  # remove this individual as they are specifically excluded from the cohort as a duplicate
  filter(!str_detect(member, "36841201")) %>%
  select(prior_health_care:deathyear) %>%
  bind_cols(select(cohort_2018_deid, uuid, sex), .) -> health_data
```


Now let's take a look at the data:
```{r}
skimr::skim(health_data)
```


The first thing to determine is whether `prior_health_care` refers to,
"does this person have a history of a health care condition," or something else.
```{r}
health_data %>%
  select(prior_health_care, prior_diagnosis) %>%
  table()
```


From this it would appear that prior healthcare is a yes/no question
that tells us if they have any history of health care conditions.
```{r}
health_data %>%
  mutate(prior_health_condition_clean = case_when(
    prior_health_care == "Yes" ~ "Yes", 
    !is.na(prior_diagnosis) ~ "Yes",
    TRUE ~ "No")
    ) -> health_data_
```


Now let's look at the `prior_diagnosis` column:
```{r}
health_data_ %>%
  select(prior_diagnosis) %>%
  table()
```


```{r}
health_data_ %>%
  select(other_prior_diagnosis) %>%
  table()
```


In the secondary column, we see many values that are translated. We'll translate
these manually and then cast them width wise to create a wide format table.

First, we mutate the `prior_diagnosis` column to make sure a diagnosis is one word, or clearly separated by a comma:
```{r}
health_data_ %>%
  mutate(prior_diagnosis_ = 
    prior_diagnosis %>% 
      str_to_lower() %>%
      str_replace("infected wound prior diagnosis other", "infected_wound") %>%
      str_replace("malaria cancer", "malaria,cancer") %>%
      str_replace("malaria prior diagnosis other", "malaria") %>%
      str_replace("no pregnancy prior diagnosis other", "no_pregnancy") %>%
      str_replace("no pregnancy", "no_pregnancy") %>%
      str_replace("prior diagnosis other", "other") %>%
      str_replace("hypertension idr", "hypertension") %>%
      str_replace("no diagnosis", NA_character_) %>%
      str_replace("idr", NA_character_)
  ) %>%
  select(prior_diagnosis_) %>%
  table()
```


Then, we concatenate the `prior_diagnosis` and `other_prior_diagnosis` columns to create a single diagnosis column separated by commas:
```{r}
health_data_ %>%
  mutate(prior_diagnosis_ = 
    prior_diagnosis %>% 
      str_to_lower() %>%
      str_replace("infected wound prior diagnosis other", "infected_wound") %>%
      str_replace("malaria cancer", "malaria,cancer") %>%
      str_replace("malaria prior diagnosis other", "malaria") %>%
      str_replace("no pregnancy prior diagnosis other", "no_pregnancy") %>%
      str_replace("no pregnancy", "no_pregnancy") %>%
      str_replace("prior diagnosis other", "other") %>%
      str_replace("hypertension idr", "hypertension") %>%
      str_replace("no diagnosis", NA_character_) %>%
      str_replace("idr", NA_character_)
  ) %>%
  mutate(other_prior_diagnosis = 
    other_prior_diagnosis %>% 
      str_to_lower() %>%
      str_replace("infected wound prior diagnosis other", "infected_wound") %>%
      str_replace("malaria cancer", "malaria,cancer") %>%
      str_replace("malaria prior diagnosis other", "malaria") %>%
      str_replace("no pregnancy prior diagnosis other", "no_pregnancy") %>%
      str_replace("no pregnancy", "no_pregnancy") %>%
      str_replace("prior diagnosis other", "other") %>%
      str_replace("hypertension idr", "hypertension") %>%
      str_replace("no diagnosis", NA_character_) %>%
      str_replace("idr", NA_character_)
  ) %>%
  unite(diagnoses_all, prior_diagnosis_, other_prior_diagnosis, sep = ",", remove=FALSE, na.rm=TRUE) %>%
  mutate(
    diagnoses_all = 
      str_squish(diagnoses_all) %>% 
        str_replace(", ", ",") %>%
        str_replace(" ", "_") %>%
        # if it just starts with "other," it means it has only "other diagnosis"
        # and can be safely removed
        str_replace("^other,", "") %>%
        # which means the ones that are 999 are true "other" diagnoses
        # with no specification in english
        str_replace("999", "other_unspecified")
  ) %>%
  mutate(diagnoses_all = na_if(diagnoses_all, "")) %>%
  select(diagnoses_all) %>%
  table()
```


Now we have a single column with all diagnoses separated by a comma. We can
use this to create a wide format table with each diagnosis as a column.

These values can then be translated and categorised into ICD10 categories, which might be useful
for cross-cultural comparisons and publications.
    
```{r malagasy_diagnosis_lookup_table}
malagasy_diagnosis_lookup_table <- tribble(
  ~raw,                  ~diagnosis_english,             ~icd10_code, ~icd10_description,
  "aretim_bavony",       "Gastrointestinal",             "K00–K95",   "Diseases of the digestive system",
  "adetin_kibo",         "Gastrointestinal",             "K00–K95",   "Diseases of the digestive system",
  "farasisa",            "Hernia or Prolapse",           "K40–K46",   "Abdominal hernia",
  "hernie",              "Hernia or Prolapse",           "K40–K46",   "Abdominal hernia",
  "voatombo_komby",      "Hernia or Prolapse",           "K40–K46",   "Abdominal hernia",
  "zonisy,farasisa",     "Hernia or Prolapse",           "K40–K46",   "Abdominal hernia",
  "aretintsofina",       "ENT (Ear/Nose/Throat)",        "H60–H95",   "Diseases of the ear and mastoid process",
  "hoditra_fotsy",       "Genetic / Albinism",           "E70–E90",   "Metabolic disorders (incl. albinism)",
  "solopiso",            "Neurological (Epilepsy)",      "G40",       "Epilepsy and recurrent seizures",
  "mentally_handicapped","Developmental / Cognitive",    "F70–F79",   "Intellectual disabilities",
  "bongabe",             "Swelling / Mass",              "R22",       "Localized swelling, mass and lump",
  "mangoraka,tadigny",   "Dermatologic",                 "L00–L99",   "Diseases of the skin and subcutaneous tissue",
  "tadigny",             "Dermatologic",                 "L00–L99",   "Diseases of the skin and subcutaneous tissue",
  "matetika_tontona",    "Dizziness / Syncope",          "R42",       "Dizziness and giddiness",
  "tontona",             "Dizziness / Syncope",          "R42",       "Dizziness and giddiness",
  "sohiky",              "Musculoskeletal Deformity",    "M40–M54",   "Deforming dorsopathies",
  "soiky",               "Musculoskeletal Deformity",    "M40–M54",   "Deforming dorsopathies",
  "torantorana",         "Motor Disability",             "M62",       "Disorders of muscle",
  "hypertension",        "Hypertension",                 "I10",       "Essential (primary) hypertension",
  "malaria",             "Malaria",                      "B50–B54",   "Malaria",
  "tuberculosis",        "Tuberculosis",                 "A15–A19",   "Respiratory and other tuberculosis",
  "infected_wound",      "Skin or soft tissue infection","L00–L08",   "Infections of the skin and subcutaneous tissue",
  "no_pregnancy",        "Pregnancy-related",            "O00–O99",   "Pregnancy, childbirth and the puerperium",
  "cancer",              "Neoplasm (unspecified)",       "C00–D49",   "Neoplasms",
  "other",               "Other / Unknown",              "R69",       "Unknown and unspecified causes of morbidity"
)
# Save to package
usethis::use_data(malagasy_diagnosis_lookup_table, overwrite = TRUE)
```


You can examine this lookup table in the vignette [`Pipeline Outputs`](OutputTables.html).
  
With that, we can implement it in the function:
  
  
```{r example-create_health_diagnoses}
#| eval: no

health_data_ %>% 
  create_health_diagnoses() %>%
  summary()
```

  


# preprocess_2018_health


```{r examples-preprocess_2018_health}
preprocess_2018_health()
```




