---
title: "Pipeline Outputs"
author: "Tinashe M. Tapera"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Pipeline Outputs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(here)
library(DT)
library(targets)
library(MAHERYCohortHarmonization)
tar_load_everything(strict=FALSE, store = here::here("_targets"))
```

In this vignette, we provide interactive tables to view the outputs of the pipeline. The tables are rendered using the `DT` package, which provides a simple way to create interactive tables in R.

## 2018 Cohort

### Cohort Demographics

The cohort demographics are the base of the project. The targets object `cohort_2018` is what generates this table:

```{r, results='asis'}
datatable(cohort_2018)
```

The preprocessing details for this step are in the notebook 

### Cohort Household Heads

Head of household are an important demographic variable. In Madagascar, as in many countries, the household head
(or chef de ménage) is a key unit of reference in population-level analyses, especially in surveys, censuses, 
and administrative datasets. In Madagascar, household headship can also reflect traditional norms and ethnic
practices, which might influence the structure and function of households. Extended family households with multiple
generations under one roof are common in some regions, and the definition of “head” may differ from a purely economic
or legal interpretation. The targets object `cohort_2018_households` is what generates this table:

```{r, results='asis'}
datatable(cohort_2018_households)
```

### Cohort 2018 Health

We create a separate table for health-related data, which includes diagnoses and other health indicators.

The health diagnoses lookup table is an important part of this output. It provides a mapping between the local
Malagasy survey answers and the standardized health diagnoses codes used in the project.

```{r, results='asis'}
data("malagasy_diagnosis_lookup_table", package = "MAHERYCohortHarmonization")
datatable(malagasy_diagnosis_lookup_table)
```

The final health table for the 2018 cohort is generated by the targets object `cohort_2018_health`:

```{r, results='asis'}
datatable(cohort_2018_healthcare)
```

## 2019 Cohort 

### Demographics

The 2019 cohort demographics are generated by the targets object `cohort_2019`.

```{r, results ='asis'}
datatable(cohort_2019)
```

## 2018 to 2019 Cohort Overlap

We're seeing how many individuals from the 2018 cohort are also present in the 2019 cohort. This is important for understanding the continuity of the cohort over time.

```{r}
table(cohort_2019$uuid %in% cohort_2018$uuid)
```

From the looks of it, there are only 100 people we were able to transfer successfully.
As a reminder, we generate the uuid by using the combination of name, household, DoB, and sex,
and then create a hash of that combination to create a unique identifier. So supposedly,
if someone has the same data for all of those, they should carry over from cohort to cohort.

The only other exception to this could be that the individual moved household.

## Pipeline

The `targets` package is how we manage the data engineering pipeline. 